# charts/jellyfin/templates/httproute.yaml
{{- if and .Values.route.enabled (eq .Values.route.type "httproute") }}
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ include "app.fullname" . }}-route
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "app.labels" . | nindent 4 }}
    {{- range $key, $value := .Values.route.labels }}
    {{- printf "%s: %s" $key (tpl $value $ | quote) | nindent 4 }}
    {{- end }}
  {{- with .Values.route.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if .Values.route.parentRefs }}
  parentRefs:
  {{- range .Values.route.parentRefs }}
  - name: {{ .name }}
    {{- if .namespace }}
    namespace: {{ .namespace }}
    {{- end }}
    {{- if .sectionName }}
    sectionName: {{ .sectionName }}
    {{- end }}
    {{- if .port }}
    port: {{ .port }}
    {{- end }}
  {{- end }}
  {{- else }}
  # Fallback to parent chart's gateway
  parentRefs:
  - name: {{ .Release.Name }}-gateway
    namespace: {{ .Release.Namespace }}
  {{- end }}
  {{- with .Values.route.hostnames }}
  hostnames:
  {{- toYaml . | nindent 2 }}
  {{- end }}
  rules:
  {{- range .Values.route.rules }}
  - matches:
    {{- if .matches }}
    {{- toYaml .matches | nindent 4 }}
    {{- else }}
    - path:
        type: PathPrefix
        value: /
    {{- end }}
    {{- if .filters }}
    filters:
    {{- toYaml .filters | nindent 4 }}
    {{- end }}
    backendRefs:
    {{- if .backendRefs }}
    {{- toYaml .backendRefs | nindent 4 }}
    {{- else }}
    - name: {{ include "app.fullname" $ }}
      port: {{ $.Values.containerPort }}
      {{- if .weight }}
      weight: {{ .weight }}
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}